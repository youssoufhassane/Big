<?php

if (session_status() == PHP_SESSION_NONE) {
    session_start();

    if (!isset($_SESSION['LOGIN'])) {
        header("Location: /Test/index.php");
        exit();
    }


    if (!isset($_SESSION['droits'])) {
        // Initialiser les droits si non définis
        $_SESSION['droits'] = array(
            'LECTURE' => 0,
            'CREATION' => 0,
            'MODIFICATION' => 0,
            'PARAMETRE' => 0,
            'UTILISATEUR' => 0
        );
    }
}


// Connexion à la base de données
require "/wamp64/www/Test/server/data.php";


$query = "
SELECT 
    oc.DATE_COLLECTE AS DATE_COLLECTE, 
    oc.VOLUME_COLLECTE AS VOLUME_COLLECTE,
    ot.VOLUME_AVANT_TRANSFORMATION AS VOLUME_AVANT_TRANSFORMATION,
    pv.QUANTITE AS QUANTITE
FROM 
    operation_collecte oc
LEFT JOIN 
    operation_transformation ot ON oc.DATE_COLLECTE = ot.DATE_TRANSFORMATION
LEFT JOIN 
    produit_vendu pv ON oc.DATE_COLLECTE = pv.DATE_VENDU

";

$result = $conn->query($query);

$data = [];
while ($row = $result->fetch_assoc()) {
    $data[] = $row;
}

// Transformer les données en JSON pour Chart.js
$json_data = json_encode($data);
?>


<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Reporting</title>
    <style>
        .container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            flex-direction: column;
            text-align: center;
        }

        canvas {
            max-width: 100%;
            height: auto;
        }

        @media(min-width:768px) {
            h1 {
                margin-top: 20%;
            }
        }

        .search {
            display: flex;
            justify-content: center;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 class="text-center">Statistiques des Transactions de volume</h1>
        <div class="search col-6">
            <div class="mb-3">
                <label for="start-date" class="form-label">Date de début</label>
                <input type="date" id="start-date" class="form-control">
            </div>
            <div class="mb-3">
                <label for="end-date" class="form-label">Date de fin</label>
                <input type="date" id="end-date" class="form-control">
            </div>
        </div>
        <button id="filter-custom" class="btn btn-success my-1">Appliquer</button>

        <canvas id="myChart"></canvas>
        <div class="resume">
            <a href="/Test/acceuil.php" class="btn btn-success">Retour à l'acceuil</a>
            <?php if ($_SESSION['droits']['LECTURE'] == 1 || $_SESSION['droits']['CREATION'] == 1) { ?>
                <?php if ($_SESSION['PROFIL'] == 'superviseur' || $_SESSION['PROFIL'] == 'administrateur') { ?>
                    <a href="/Test/Tables/resume.php" class="btn btn-info">Résume</a>
                    <a href="/Test/Tables/resum.php" class="btn btn-warning">Rapport d'etat</a>
                <?php } ?>
            <?php } ?>
        </div>
    </div>
    <script>
        let allData = <?php echo $json_data; ?>; // Conserver toutes les données pour les filtres
        let chart;

        function aggregateDataByDate(data) {
            let aggregatedData = {};
            data.forEach(item => {
                let date = item.DATE_COLLECTE;
                if (!aggregatedData[date]) {
                    aggregatedData[date] = {
                        label: date,
                        VOLUME_COLLECTE: 0,
                        VOLUME_AVANT_TRANSFORMATION: 0,
                        QUANTITE: 0
                    };
                }
                aggregatedData[date].VOLUME_COLLECTE += parseFloat(item.VOLUME_COLLECTE) ||
                    0;
                aggregatedData[date].VOLUME_AVANT_TRANSFORMATION +=
                    parseFloat(item.VOLUME_AVANT_TRANSFORMATION) || 0;
                aggregatedData[date].QUANTITE += parseFloat(item.QUANTITE) || 0;
            });
            return Object.values(aggregatedData);
        }

        function createChart(data) {
            let filteredData = aggregateDataByDate(data);
            let labels = filteredData.map(item => item.label);
            let VOLUME_COLLECTE = filteredData.map(item => item.VOLUME_COLLECTE);
            let VOLUME_AVANT_TRANSFORMATION = filteredData.map(item =>
                item.VOLUME_AVANT_TRANSFORMATION);
            let QUANTITE = filteredData.map(item => item.QUANTITE);
            if (chart) {
                chart.destroy();
            }
            chart = new Chart(document.getElementById('myChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                            label: 'Volume Collecte',
                            data: VOLUME_COLLECTE,
                            backgroundColor: 'rgba(75, 12, 192, 0.2)',
                            borderColor: 'rgba(75, 12, 192, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Volume Transformation',
                            data: VOLUME_AVANT_TRANSFORMATION,
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Quantite Vendu',
                            data: QUANTITE,
                            backgroundColor: 'rgba(239 18 18 / 20%)',
                            borderColor: 'rgba(239 18 18 / 29%)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function filterDataByCustomPeriod() {
            let startDate = new Date(document.getElementById('start-date').value);
            let endDate = new Date(document.getElementById('end-date').value);
            if (startDate && endDate && !isNaN(startDate) && !isNaN(endDate)) {
                let filteredData = allData.filter(item => {
                    let itemDate = new Date(item.DATE_COLLECTE);
                    return itemDate >= startDate && itemDate <= endDate;
                });
                // Met à jour le graphique avec les données filtrées
                createChart(filteredData);
            } else {
                alert("Veuillez entrer des dates valides.");
            }
        }
        document.getElementById('filter-custom').addEventListener('click',
            filterDataByCustomPeriod);
        // Initial chart
        createChart(allData);
    </script>
</body>

</html>